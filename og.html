<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reddit Moderation Evaluation</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.21/lodash.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; line-height: 1.6; padding: 20px; max-width: 800px; margin: 0 auto; }
        textarea { width: 100%; height: 200px; margin-bottom: 10px; }
        button { padding: 10px; background-color: #4CAF50; color: white; border: none; cursor: pointer; margin-bottom: 10px; }
        button:hover { background-color: #45a049; }
        #results { margin-top: 20px; }
        .progress { width: 100%; background-color: #ddd; }
        .progress-bar { width: 0; height: 30px; background-color: #4CAF50; text-align: center; line-height: 30px; color: white; }
        .file-input { margin-bottom: 10px; }
    </style>
</head>
<body>
    <h1>Reddit Moderation Evaluation</h1>
    <textarea id="prompt" placeholder="Enter your main prompt here..."></textarea>
    <div class="file-input">
        <label for="rulesFile">Upload RULES.DB file:</label>
        <input type="file" id="rulesFile" accept=".DB,.json">
    </div>
    <div class="file-input">
        <label for="csvFile">Upload CSV file:</label>
        <input type="file" id="csvFile" accept=".csv">
    </div>
    <button onclick="processFiles()">Process Files</button>
    <div id="progress" class="progress" style="display:none;">
        <div id="progress-bar" class="progress-bar"></div>
    </div>
    <div id="results"></div>

    <script>
        let df = [];
        let rulesDB = {};

        function processFiles() {
            const rulesFile = document.getElementById('rulesFile').files[0];
            const csvFile = document.getElementById('csvFile').files[0];
            const prompt = document.getElementById('prompt').value;

            if (!rulesFile || !csvFile) {
                alert('Please select both RULES.DB and CSV files');
                return;
            }
            if (!prompt) {
                alert('Please enter a main prompt');
                return;
            }

            const rulesReader = new FileReader();
            rulesReader.onload = function(e) {
                try {
                    rulesDB = JSON.parse(e.target.result);
                    processCsvFile(csvFile, prompt);
                } catch (error) {
                    console.error('Error parsing RULES.DB:', error);
                    alert('Error parsing RULES.DB file. Please make sure it\'s a valid JSON file.');
                }
            };
            rulesReader.readAsText(rulesFile);
        }

        function processCsvFile(file, prompt) {
            Papa.parse(file, {
                complete: function(results) {
                    df = results.data;
                    processData(prompt);
                }
            });
        }

        function processData(prompt) {
            const progressBar = document.getElementById('progress-bar');
            const progressContainer = document.getElementById('progress');
            progressContainer.style.display = 'block';
            let processedRows = 0;

            const processRow = (index) => {
                if (index >= df.length) {
                    evaluateResults();
                    return;
                }

                const row = df[index];
                const subreddit = row[9]; // Assuming subreddit is in the 10th column
                const postTitle = row[3]; // Assuming post_title is in the 4th column
                const postBody = row[4] || "(empty)"; // Assuming post_body is in the 5th column
                const postFlair = row[5] || "(empty)"; // Assuming post_flair is in the 6th column
                const labels = row[8].replace("RULE_", "").replace("|", ","); // Assuming label is in the 9th column

                const policyRules = `
                    - Remember the human. Reddit is a place for creating community and belonging, not for attacking marginalized or vulnerable groups of people. Everyone has a right to use Reddit free of harassment, bullying, and threats of violence. Communities and users that incite violence or that promote hate based on identity or vulnerability will be banned.
                    - Abide by community rules. Post authentic content into communities where you have a personal interest, and do not cheat or engage in content manipulation (including spamming, vote manipulation, ban evasion, or subscriber fraud) or otherwise interfere with or disrupt Reddit communities.
                    - Respect the privacy of others. Instigating harassment, for example by revealing someone's personal or confidential information, is not allowed. Never post or threaten to post intimate or sexually-explicit media of someone without their consent.
                    - Do not share or encourage the sharing of sexual, abusive, or suggestive content involving minors. Any predatory or inappropriate behavior involving a minor is also strictly prohibited.
                    - You don't have to use your real name to use Reddit, but don't impersonate an individual or an entity in a misleading or deceptive manner.
                    - Ensure people have predictable experiences on Reddit by properly labeling content and communities, particularly content that is graphic, sexually-explicit, or offensive.
                    - Keep it legal, and avoid posting illegal content or soliciting or facilitating illegal or prohibited transactions.
                    - Don't break the site or do anything that interferes with normal use of Reddit.
                `.trim();

                const subredditRules = getRules(subreddit);

                const formattedPrompt = prompt.replace('{subreddit}', subreddit)
                    .replace('{post_title}', postTitle)
                    .replace('{post_body}', postBody)
                    .replace('{post_flair}', postFlair)
                    .replace('{policy_rules}', policyRules)
                    .replace('{subreddit_rules}', subredditRules);

                // Simulating API call to Gemini
                setTimeout(() => {
                    const fakeResponse = simulateGeminiResponse(labels);
                    df[index].push(fakeResponse.result);
                    df[index].push(fakeResponse.explanation);
                    df[index].push(fakeResponse.confidence);

                    processedRows++;
                    const progress = (processedRows / df.length) * 100;
                    progressBar.style.width = progress + '%';
                    progressBar.textContent = Math.round(progress) + '%';

                    processRow(index + 1);
                }, 100); // Simulating API delay
            };

            processRow(0);
        }

        function getRules(subreddit) {
            if (!rulesDB[subreddit]) return "No rules found for this subreddit.";
            let rules = [];
            rulesDB[subreddit].rules.forEach((rule, index) => {
                const name = rule.name.replace(/^rule [# ]*[0-9]+[ .:-]*/i, "");
                const text = `${name}\n${rule.description}`.trim();
                rules.push(`# Rule ${index + 1}: ${text}`);
            });
            return rules.join("\n\n");
        }

        function simulateGeminiResponse(trueLabels) {
            // This is a placeholder. In reality, you'd make an API call to Gemini here.
            const result = Math.random() < 0.9 ? trueLabels : (Math.random() < 0.5 ? "OK" : "POLICY");
            return {
                result: result,
                explanation: `Simulated explanation for ${result}`,
                confidence: Math.random().toFixed(2)
            };
        }

        function evaluateResults() {
            const results = document.getElementById('results');
            const trueLabels = df.map(row => new Set(row[8].toUpperCase().replace("RULE_", "").replace("POLICY", "P").split('|')));
            const predLabels = df.map(row => new Set(row[10].toUpperCase().replace("RULE_", "").replace("POLICY", "P").split(',')));

            const exactMatches = trueLabels.filter((label, i) => _.isEqual(label, predLabels[i])).length;
            const partialMatches = trueLabels.filter((label, i) => label.size === 0 ? predLabels[i].size === 0 : _.intersection([...label], [...predLabels[i]]).length > 0).length;

            const exactAccuracy = exactMatches / df.length;
            const partialAccuracy = partialMatches / df.length;

            // Simple precision calculation
            const correctPredictions = trueLabels.filter((label, i) => 
                (label.has("OK") && predLabels[i].has("OK")) || 
                (!label.has("OK") && !predLabels[i].has("OK"))
            ).length;
            const precision = correctPredictions / df.length;

            results.innerHTML = `
                <h2>Evaluation Results</h2>
                <p>Exact Match Accuracy: ${(exactAccuracy * 100).toFixed(2)}%</p>
                <p>Partial Match Accuracy: ${(partialAccuracy * 100).toFixed(2)}%</p>
                <p>Precision: ${(precision * 100).toFixed(2)}%</p>
            `;
        }
    </script>
</body>
</html>
